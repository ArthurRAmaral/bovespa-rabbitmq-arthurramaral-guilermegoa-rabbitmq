<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>{{corretora}}</title>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>
  <h1>
    {{ corretora }}
  </h1>

  <div>

    <form id="form">
      <span>
        Quantidade de ativos:
      </span>
      <input type="number" min="1" name="quantidade">
      <br>
      <span>
        Valor por ativo:
      </span>
      <input type="number" name="valor" min="1" step="0.01" />
      <br>
      <span>
        Nome do ativo:
      </span>
      <input type="text" name="ativo" />
      <br>
      <span>
        Método:
      </span>
      <select name="tipo">
        <option value="">-</option>
        <option value="compra">compra</option>
        <option value="venda">venda</option>
      </select>
      <br>
      <input type="submit" value="Enviar">
    </form>
  </div>
  <div>
    <span>Novas transações:</span>
    <ul id="transacoes"></ul>
  </div>
  <script>
    const form = document.getElementById('form');
    const inputs = form.elements;

    function inputInvalido() {
      alert('Preencha todos os campos');
    }

    function createBody() {
      return JSON.stringify({
        quantidade: inputs['quantidade'].value,
        valor: inputs['valor'].value,
        ativo: inputs['ativo'].value,
      });
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();

      const operacao = inputs['tipo'].value;

      switch (operacao) {
        case 'compra':
        case 'venda':
          fetch(`./api/${operacao}`, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: createBody()
          }).then((res) => {
            return res.text();
          }).then((data) => {
            if (data)
              alert(`Pedido de ${operacao} registrado`)
            else
              alert(`Erro ao registrar o pedido de ${operacao}`)
            console.log(data);
          })
          break;
        default:
          inputInvalido()
          break;
      }
    })


    const listaDeTransacoes = document.querySelector('#transacoes');

    const socket = new io(`http://${window.location.host}`);

    socket.addEventListener('open', () => {
      console.info('Socket connected');
    });

    socket.addEventListener('transactions', (event) => {
      const listItem = document.createElement('li');

      listItem.textContent = event.data;
      listaDeTransacoes.appendChild(listItem);
    });
  </script>
</body>

</html>